# Phase 10: 스마트 동기화 및 수동 갱신

Eternal 캐싱 전략의 한계를 보완하여 다중 기기 간 데이터 동기화와 수동 갱신 기능을 제공합니다.

## 🎯 목표

- 다른 기기에서 발생한 데이터 변경사항 감지 및 동기화
- 사용자 주도의 수동 새로고침 기능 제공
- 최소한의 네트워크 요청으로 데이터 신선도 유지

## 📋 배경

**Eternal 캐싱의 장단점:**
- ✅ **장점**: 로컬 속도 최강, 네트워크 요청 최소화
- ❌ **한계**: 다른 기기(PC 등)에서 발생한 데이터 변화를 감지하지 못함

**해결 방향:**
- 초경량 "핑(Ping)" API로 변경사항만 체크
- 사용자가 원할 때 수동으로 새로고침할 수 있는 통로 제공

## 📋 작업 목록

### 10.1 변경 감지 API 구축

- [ ] **Ping API 구현** (`/api/ping` 또는 `/api/sync/check`)
  - 유저별 `last_updated_at` 시간값만 반환 (초경량 쿼리)
  - 북마크, 폴더 각각의 최종 수정 시간 포함
  - 응답 크기 최소화 (수십 바이트)

- [ ] **클라이언트 변경 감지 로직**
  - 앱 포커싱 시 (`window.focus` 이벤트) Ping API 호출
  - 로컬 캐시의 마지막 업데이트 시간과 서버 시간 비교
  - 서버 시간이 최신일 경우에만 `invalidateQueries` 실행

- [ ] **로컬 타임스탬프 관리**
  - localStorage에 마지막 동기화 시간 저장
  - Mutation 성공 시 타임스탬프 업데이트

---

### 10.2 Pull to Refresh 구현

- [ ] **제스처 감지**
  - 스크롤 최상단에서 아래로 당기는 동작 감지
  - 터치 이벤트 핸들링 (`touchstart`, `touchmove`, `touchend`)

- [ ] **시각적 피드백**
  - 당기는 동작 시 "당겨서 새로고침" 문구 노출
  - 당기는 거리에 따른 애니메이션 (화살표 회전 등)
  - 임계값 도달 시 "놓으면 새로고침" 문구로 변경

- [ ] **강제 갱신 트리거**
  - 새로고침 제스처 완료 시 모든 쿼리 `invalidate`
  - 로딩 스피너 표시
  - 완료 후 "최신 데이터로 업데이트됨" 피드백

- [ ] **적용 페이지**
  - 홈 화면 (북마크/폴더 목록)
  - 북마크 상세 페이지
  - 프로필 페이지

---

### 10.3 동기화 전략 최적화

- [ ] **네트워크 상태 기반 동작**
  - 오프라인: Pull to Refresh 비활성화, "오프라인 상태" 안내
  - 온라인 복귀: 자동으로 변경사항 체크

- [ ] **배터리 및 성능 고려**
  - Ping API 호출 빈도 제한 (최소 5분 간격)
  - 백그라운드에서는 호출하지 않음
  - debounce 적용으로 불필요한 요청 방지

- [ ] **사용자 알림**
  - 새 데이터 감지 시 "새로운 변경사항이 있습니다" 배너 표시
  - 사용자가 직접 "새로고침" 버튼 클릭하여 적용

---

## 💡 구현 방향성

### Ping API 설계

**요청:**
```
GET /api/sync/check
```

**응답:**
```json
{
  "bookmarks_updated_at": "2026-01-11T12:34:56Z",
  "folders_updated_at": "2026-01-11T10:20:30Z"
}
```

### Pull to Refresh 라이브러리

**옵션:**
- 직접 구현 (터치 이벤트)
- `react-simple-pull-to-refresh` 활용
- 모바일 네이티브 패턴 준수

### 동기화 흐름

1. **앱 포커싱 시**
   - Ping API 호출
   - 서버 타임스탬프 vs 로컬 타임스탬프 비교
   - 불일치 시: "새 데이터 있음" 배너 표시

2. **Pull to Refresh 시**
   - 모든 쿼리 강제 무효화
   - 서버에서 최신 데이터 fetch
   - 로컬 타임스탬프 업데이트

3. **Mutation 발생 시**
   - 로컬 타임스탬프 업데이트
   - 다른 기기에서 감지 가능하도록 서버 타임스탬프 갱신

---

## 📊 예상 효과

### 데이터 신선도
- 다중 기기 사용 시에도 최신 데이터 유지
- 최소한의 네트워크 비용으로 동기화 감지

### 사용자 경험
- **자동 감지**: 앱 재진입 시 변경사항 자동 체크
- **수동 제어**: 원할 때 언제든 Pull to Refresh로 갱신
- **투명성**: "새 데이터 있음" 배너로 명확한 안내

### 네트워크 효율
- Ping API: 수십 바이트 (기존 대비 99% 감소)
- 변경 없을 때: 추가 fetch 없음
- 변경 있을 때만: 필요한 리소스만 갱신

---

## 🔄 Phase 6과의 연계

Phase 6에서 구축한 Eternal 캐싱 전략을 유지하면서, 다중 기기 환경에서의 한계를 보완합니다.

- **Phase 6**: 단일 기기에서 최강의 성능
- **Phase 10**: 다중 기기 간 데이터 일관성 보장
- **결합 효과**: Local-First + Smart Sync = 완벽한 모바일 앱 경험