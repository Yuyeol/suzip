# Phase 6: React Query 캐싱 전략 최적화 (Personal App Edition)

## 상태: 완료 ✅

---

## 개요

본 프로젝트는 사용자가 자신의 북마크를 직접 관리하는 **개인화 서비스(Personal App)**입니다. 타인에 의한 데이터 변경 가능성이 없으므로, **"사용자가 직접 데이터를 수정할 때만 서버와 동기화한다"**는 전제하에 성능을 극대화합니다. 특히 PWA 환경에서 네이티브 앱과 같은 경험을 위해 **영구 캐싱(Eternal Caching)**과 **지속성(Persistence)**을 결합한 Local-First 아키텍처를 구축했습니다.

---

## 6.1 버그 수정 및 기반 강화 (P0) - [완료]

### 구현 항목

- [x] QueryKeyFactory에 `is_favorite` 파라미터 추가 (필터링 정합성)
- [x] 모든 Mutation에 `refetchType: 'active'` 추가 (불필요한 배경 리페칭 방지)
- [x] 상호 의존적 데이터 캐시 무효화 로직 보완 (폴더 ↔ 북마크 연동)

---

## 6.2 영구 캐싱(Eternal Caching) 전략 (P1) - [완료]

### 구현 항목

- [x] 캐싱 설정 상수 중앙 관리 (`src/shared/constants/queryConfig.ts`)
- [x] 전역 영구 신선도 설정 (`staleTime: Infinity`)
- [x] Mutation 성공 시 캐시 즉시 업데이트 (`setQueryData` 주입)
  - `usePostFavorite`, `usePatchBookmark` 등 주요 액션에 적용

---

## 6.3 지속성(Persistence) 및 하이드레이션 최적화 (P0) - [완료]

### 구현 항목

- [x] **로컬스토리지 백업 체계 구축**
  - `@tanstack/query-async-storage-persister`를 통한 비동기 저장 환경 구성
  - `maxAge: Infinity`로 앱 재진입 시 기존 캐시 100% 신뢰 및 복원
- [x] **데이터 보존 정책 극대화**
  - `GC_TIME: Infinity` 설정으로 사용하지 않는 데이터의 자동 삭제 방지
- [x] **하이드레이션 불일치(Mismatch) 근본적 해결**
  - 로컬 캐시 데이터와 서버 HTML 충돌을 방지하기 위해 데이터 의존적 컴포넌트/페이지에 `ssr: false` (Dynamic Import) 적용
  - 대상: `BookmarksTab`, `FoldersTab`, `FilterControls`, 상세 및 관리 페이지 전체

---

## 최종 캐싱 정책 (queryConfig)

| 구분            | 상수명         | 값         | 목적                             |
| :-------------- | :------------- | :--------- | :------------------------------- |
| **신선도 유지** | `STALE_TIME`   | `Infinity` | 수동 갱신 전까지 서버 요청 차단  |
| **메모리 보존** | `GC_TIME`      | `Infinity` | 메모리에서 데이터 자동 삭제 방지 |
| **로컬 백업**   | `PERSIST_TIME` | `Infinity` | 로컬스토리지 데이터 영구 보관    |

---

## 예상 효과 (개선 후)

### 네트워크 요청 감소율

| 시나리오                | 개선 전 (1분 캐시) | 개선 후 (Eternal + Persistence) | 감소율       |
| :---------------------- | :----------------- | :------------------------------ | :----------- |
| **앱 완전히 껐다 켜기** | 매번 전체 로드     | **요청 0회 (캐시 즉시 복원)**   | **100%**     |
| **하루 10회 재접속**    | 각 리소스 10회     | 각 리소스 1회 (최초)            | **90%**      |
| **탭 전환 100회**       | 리소스 100회 요청  | 요청 0회                        | **100%**     |
| **일반적인 사용**       | 시간당 수십 건     | Mutation 발생 시에만 1-2건      | **95% 이상** |

---
