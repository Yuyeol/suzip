# Phase 6: React Query 캐싱 전략 최적화 (Personal App Edition)

## 상태: 완료 ✅

---

## 개요

본 프로젝트는 사용자가 자신의 북마크를 직접 관리하는 **개인화 서비스(Personal App)**입니다. 타인에 의한 데이터 변경 가능성이 없으므로, **"사용자가 직접 데이터를 수정할 때만 서버와 동기화한다"**는 전제하에 성능을 극대화합니다.

---

## 6.1 버그 수정 (P0) - [완료]

### 구현 항목

- [x] QueryKeyFactory에 `is_favorite` 파라미터 추가
  - `src/shared/utils/queryKeyFactory.ts`
- [x] 모든 Mutation에 `refetchType: 'active'` 추가
  - 8개 mutation hook 수정
- [x] 상호 의존적 데이터 캐시 무효화 보완
  - 폴더 삭제 시 북마크 무효화
  - 북마크 생성/삭제/수정 시 폴더 무효화

### 기대 결과

- 즐겨찾기 필터 변경 시 UI 즉각 반응.
- 데이터 생성/수정 시 관련 리소스만 최소한으로 재요청.

---

## 6.2 Eternal Caching 전략 (P1) - [완료]

### 상태: 완료

### 구현 항목

- [x] 캐싱 설정 상수 파일 생성 및 적용
  - `src/shared/constants/queryConfig.ts`
- [x] 각 Query Hook에 로컬 우선 설정 적용 (Infinity/false)
  - `useGetProfile`, `useGetFolders`, `useGetBookmarks`, `useGetBookmark`
- [x] Mutation 성공 시 상세 캐시 즉시 업데이트 (Sync)
  - `usePostFavorite`, `usePatchBookmark`에 `setQueryData` 적용

### 리소스별 캐싱 정책

| 리소스          | staleTime    | refetchOnWindowFocus | 근거                                                     |
| --------------- | ------------ | -------------------- | -------------------------------------------------------- |
| **전체 리소스** | **Infinity** | **false**            | 사용자가 Mutation을 일으키기 전까지 데이터는 변하지 않음 |
| OG 메타         | Infinity     | false                | URL 기반 정적 데이터                                     |

---

## 예상 효과 (개선 후)

### 네트워크 요청 감소율

| 시나리오         | 개선 전 (1분 캐시) | 개선 후 (Eternal)          | 감소율       |
| ---------------- | ------------------ | -------------------------- | ------------ |
| 하루 10회 재접속 | 각 리소스 10회     | 각 리소스 1회 (최초)       | **90%**      |
| 탭 전환 100회    | 리소스 100회 요청  | 요청 0회                   | **100%**     |
| 일반적인 사용    | 시간당 수십 건     | Mutation 발생 시에만 1-2건 | **95% 이상** |

### 사용자 체감 효과

- **Zero Loading**: 앱 재진입 및 탭 전환 시 로딩 바 없이 즉시 데이터 표시 (로컬 앱 수준의 속도).
- **데이터 일관성**: 내가 수행한 동작에 대해서만 네트워크가 발생하므로 데이터 변화의 예측 가능성 증가.

---

## 검증 방법

### Eternal Cache 확인

1. 홈 접속 후 데이터 로드 확인.
2. 다른 사이트 이동 후 뒤로가기 또는 탭 복귀.
3. ✅ Network 탭에 추가 요청이 없는지 확인.

### Mutation 동기화 확인

1. 북마크 추가/수정/삭제 수행.
2. ✅ 해당 작업 직후에만 관련 쿼리가 리페칭되는지 확인.

---

## 트레이드오프

| 리스크                  | 대응 방안                                                                                |
| ----------------------- | ---------------------------------------------------------------------------------------- |
| **기기 간 동기화 지연** | PC에서 변경 후 모바일에서 즉시 확인이 필요한 경우 수동 새로고침(Pull to Refresh 등) 유도 |
| **백엔드 직접 변경**    | DB를 직접 수정하는 경우 클라이언트 캐시와 불일치 발생 (수동 새로고침으로 해결)           |

---

## 향후 개선 사항

### Optimistic Updates

이미 Eternal 전략으로 속도가 빨라졌으나, 네트워크 응답 대기 시간조차 없애기 위해 적용.

- **우선순위**: 즐겨찾기 토글 > 북마크 생성 > 폴더 수정

### Pull to Refresh

Eternal 캐싱 전략에서 유일하게 필요한 "강제 동기화" UI 요소 추가.
