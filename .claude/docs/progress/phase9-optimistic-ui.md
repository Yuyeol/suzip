# Phase 9: 낙관적 UI 및 즉시 피드백

서버 응답 대기 없이 UI를 즉시 업데이트하여 네이티브 앱과 같은 즉각적인 피드백을 제공합니다. Phase 6의 캐싱 전략과 결합하여 최상의 사용자 경험을 구현합니다.

## 🎯 목표

- 서버 응답 전에 UI 즉시 업데이트 (Optimistic Updates)
- 네트워크 지연에도 빠르게 반응하는 사용자 경험
- 실패 시 자동 롤백으로 데이터 정합성 유지

## 📋 작업 목록

### 9.1 낙관적 UI 업데이트 구현

#### 우선순위 1: 즉각 반응 필수 기능

- [x] **즐겨찾기 토글 (북마크)** (`usePostFavorite`)
  - onMutate에서 캐시 즉시 업데이트 (`Bookmark[]` 타입)
  - onError에서 롤백 처리
  - disabled로 중복 클릭 방지 (반투명 효과 없음)

- [x] **즐겨찾기 토글 (폴더)** (`usePostFolderFavorite`)
  - Star 아이콘 클릭 시 즉시 채움/비움
  - 실패 시 이전 상태로 롤백

- [x] **북마크 삭제** (`useDeleteBookmark`)
  - 삭제 버튼 클릭 시 리스트에서 즉시 제거
  - 서버 응답 대기 없이 사라짐 애니메이션
  - 실패 시 리스트에 다시 복원
  - 성공 시 폴더 목록 invalidate (bookmark_count 동기화)

- [x] **폴더 삭제** (`useDeleteFolder`)
  - 폴더 리스트에서 즉시 제거
  - 실패 시 복원

#### 우선순위 2: 향상된 경험

- [x] **북마크 수정** (`usePatchBookmark`)
  - 제목, 메모 등 변경사항 즉시 반영
  - 실패 시 이전 값으로 복원
  - 폴더 변경 시에만 폴더 목록 invalidate

- [x] **폴더 수정** (`usePatchFolder`)
  - 폴더명 등 변경사항 즉시 반영
  - 실패 시 이전 값으로 복원

- [x] **폴더 생성** (`usePostFolder`)
  - 폴더 목록에 임시 ID로 즉시 추가
  - 생성 완료 후 서버 데이터 반영을 위한 무효화

- [x] **북마크 생성** (`usePostBookmark`)
  - 북마크 목록에 임시로 즉시 추가
  - 생성 완료 후 실제 데이터 및 폴더 카운트 동기화를 위한 무효화

---

### 9.2 에러 핸들링 및 사용자 피드백

- [ ] **Toast 알림 시스템 구축**
  - 성공/실패 상태를 사용자에게 명확히 전달
  - 낙관적 업데이트 실패 시 "작업이 취소되었습니다" 안내

- [ ] **롤백 애니메이션**
  - 실패 시 부드럽게 이전 상태로 복원
  - 사용자가 변경사항을 인지할 수 있도록 시각적 효과

---

## 💡 구현 방향성

### Optimistic Updates 패턴

React Query의 `onMutate`, `onError`, `onSettled` 훅을 활용하여 구현합니다.

**기본 흐름:**

1. **onMutate**: 서버 요청 전에 캐시를 즉시 업데이트, 이전 값 백업
2. **onError**: 실패 시 백업한 이전 값으로 롤백
3. **onSettled**: 완료 후 서버 데이터로 동기화

### 우선순위 기준

- **P1 (즉각 반응 필수)**: 사용자가 자주 사용하는 액션 (즐겨찾기, 삭제)
- **P2 (향상된 경험)**: 상대적으로 덜 빈번하거나 복잡도가 높은 액션 (생성, 수정)

### Phase 6 캐싱 전략과의 연계

- Phase 6에서 구축한 영구 캐싱(`staleTime: Infinity`) 덕분에 낙관적 업데이트가 더욱 효과적
- 서버 요청 자체가 적어 롤백 발생 가능성 감소

---

## 📊 예상 효과

### 체감 성능

| 작업          | 개선 전 (서버 응답 대기) | 개선 후 (낙관적 업데이트) | 개선율        |
| :------------ | :----------------------- | :------------------------ | :------------ |
| **즐겨찾기**  | 200~500ms 대기           | 0ms (즉시 반영)           | **100%**      |
| **삭제**      | 300~600ms 대기           | 0ms (즉시 사라짐)         | **100%**      |
| **수정**      | 400~700ms 대기           | 0ms (즉시 변경)           | **100%**      |
| **전체 경험** | 느린 반응                | 네이티브 앱 수준          | **극대화** ✨ |

### 사용자 경험

- **즉각적인 피드백**: 버튼 클릭 시 기다림 없이 즉시 변경
- **네이티브 앱 느낌**: 웹이 아닌 앱처럼 느껴지는 경험
- **신뢰성**: 실패 시 자동 롤백으로 혼란 방지

### Phase 6과의 시너지

- **캐싱 전략**: 서버 요청 자체가 적음 → 롤백 거의 발생 안 함
- **로컬 우선**: 대부분의 작업이 로컬에서 완결 → 초고속 경험
- **PWA**: 오프라인에서도 낙관적 업데이트 동작 가능
